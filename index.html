<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sohbet Editörü</title>
    <!-- Tailwind CSS ve React/Babel Yüklemesi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* CSS Kaydırma Çubuğu Stili */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4B5563; /* gray-600 */
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1F2937; /* gray-800 */
        }
    </style>
</head>
<body class="bg-gray-900">

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Sabitler
    // Arka yüz (Backend) API'si için KALICI Render URL'si
    const API_BASE_URL = "https://ai-image-editor-api.onrender.com"; 
    const API_EDIT_ENDPOINT = `${API_BASE_URL}/edit`; 

    // Simülasyon için varsayılan bir başlangıç resmi
    const INITIAL_IMAGE_URL = "https://placehold.co/800x600/1E3A8A/ffffff?text=Yuklenecek+Resim";

    // Image Comparison Slider Component'i
    const ImageCompareSlider = ({ originalSrc, modifiedSrc }) => {
        const [sliderPos, setSliderPos] = useState(50);
        const containerRef = useRef(null);

        const handleInteraction = (e) => {
            if (e.buttons === 1 || e.type.includes('touch')) {
                const container = containerRef.current;
                if (!container) return;

                const rect = container.getBoundingClientRect();
                let clientX = e.clientX;

                if (e.type.includes('touch')) {
                    clientX = e.touches[0].clientX;
                }

                const newPos = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100));
                setSliderPos(newPos);
            }
        };

        return (
            <div 
                ref={containerRef}
                className="relative w-full h-[400px] md:h-[600px] overflow-hidden rounded-xl shadow-2xl cursor-ew-resize select-none"
                onMouseMove={handleInteraction}
                onTouchMove={handleInteraction}
                onMouseDown={(e) => e.preventDefault()}
                onTouchStart={(e) => e.preventDefault()}
            >
                {/* Orijinal Resim (Tümü) */}
                <img 
                    src={originalSrc} 
                    alt="Orijinal Resim" 
                    className="absolute inset-0 w-full h-full object-cover" 
                    draggable="false"
                />

                {/* Düzenlenmiş Resim (Kırpılmış) */}
                <div 
                    className="absolute inset-0 overflow-hidden" 
                    style={{ width: `${sliderPos}%` }}
                >
                    <img 
                        src={modifiedSrc} 
                        alt="Düzenlenmiş Resim" 
                        className="absolute inset-0 w-full h-full object-cover" 
                        style={{ transform: `translateX(-${100 - sliderPos}%)` }}
                        draggable="false"
                    />
                </div>

                {/* Kaydırma Çubuğu */}
                <div 
                    className="absolute top-0 bottom-0 w-1 bg-white/50 cursor-ew-resize group transition-all" 
                    style={{ left: `calc(${sliderPos}% - 0.5px)` }}
                    draggable="false"
                >
                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-white shadow-xl flex items-center justify-center border-2 border-gray-900 group-hover:w-10 group-hover:h-10 transition-all duration-150">
                        <svg className="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M8 7h8m-8 7h8M12 4v16"></path></svg>
                    </div>
                </div>
            </div>
        );
    };

    // Chatbot'un mesajlarını AI komutlarına çeviren yardımcı fonksiyon
    const handleChatResponse = (prompt) => {
        // Simülasyon: Kullanıcı komutunu AI filtre tipine çevirir.
        
        if (prompt.toLowerCase().includes('sarı')) {
            return {
                filter: 'color_change_yellow', // Sarı renk değiştirme filtresi (API'de buna karşılık gelen bir filtre olmalı)
                prompt: prompt,
                edit_command: 'change the color of the carpet to yellow' 
            };
        }
        if (prompt.toLowerCase().includes('parlak') || prompt.toLowerCase().includes('ışık')) {
            return {
                filter: 'auto_enhance', 
                prompt: prompt,
                edit_command: 'increase brightness and contrast'
            };
        }
        
        // Varsayılan: Yüz odaklama filtresi
        if (prompt.toLowerCase().includes('yüz') || prompt.toLowerCase().includes('net')) {
             return {
                filter: 'face_focus', 
                prompt: prompt,
                edit_command: 'focus and enhance the face area'
            };
        }

        // Varsayılan olarak 'auto_enhance' (otomatik iyileştirme) filtresini kullan
        return {
            filter: 'auto_enhance',
            prompt: prompt,
            edit_command: 'generic automatic enhancement'
        };
    };


    function App() {
        const [originalImage, setOriginalImage] = useState(INITIAL_IMAGE_URL);
        const [modifiedImage, setModifiedImage] = useState(INITIAL_IMAGE_URL);
        const [chatMessages, setChatMessages] = useState([]);
        const [inputPrompt, setInputPrompt] = useState("");
        const [isLoading, setIsLoading] = useState(false);

        const messagesEndRef = useRef(null);
        useEffect(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [chatMessages]);

        // Resim Yükleme Simülasyonu
        const handleImageUpload = () => {
            // Gerçek bir resim yükleme yerine, farklı bir placeholder ile simüle ediyoruz.
            const newUrl = `https://picsum.photos/800/600?r=${Date.now()}`;
            setOriginalImage(newUrl);
            setModifiedImage(newUrl);
            setChatMessages([{ type: 'system', text: 'Yeni resim yüklendi. Komutlarınızı bekliyorum.' }]);
        };

        // Resim düzenleme API çağrısı
        const callImageEditAPI = async (commandDetails) => {
            setIsLoading(true);

            // API uyku modundan uyanırken ilk istek başarısız olabilir.
            const systemMessage = { 
                type: 'system', 
                text: `AI düzenlemeye başladı... Komut: ${commandDetails.edit_command}` 
            };
            setChatMessages(prev => [...prev, systemMessage]);

            try {
                const response = await fetch(API_EDIT_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        image_url: originalImage, 
                        filter: commandDetails.filter,
                        prompt: commandDetails.edit_command 
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    // Başarılı olursa, düzenlenmiş resmi güncelliyoruz (Simülasyon)
                    const newModifiedUrl = `https://placehold.co/800x600/3B82F6/ffffff?text=DUZENLENDI`;
                    setModifiedImage(newModifiedUrl);
                    
                    setChatMessages(prev => [...prev, { 
                        type: 'system', 
                        text: `Resminiz başarıyla düzenlendi! Mesaj: ${data.message}`
                    }]);
                } else {
                    // API Hatası
                    setChatMessages(prev => [...prev, { 
                        type: 'system', 
                        text: `Hata: API isteği başarısız oldu (${response.status}). Render'ı kontrol edin.` 
                    }]);
                }
            } catch (error) {
                 // Bağlantı Hatası (Render uyku modu)
                setChatMessages(prev => [...prev, { 
                    type: 'system', 
                    text: `Bağlantı Hatası: Render API şu an uyku modunda olabilir (502 hatası). Lütfen 10 saniye bekleyip tekrar deneyin.` 
                }]);
                console.error("API Hata:", error);
            } finally {
                setIsLoading(false);
            }
        };

        // Chatbot mesajı gönderme
        const handleSendPrompt = (e) => {
            e.preventDefault();
            const prompt = inputPrompt.trim();
            if (!prompt || isLoading) return;

            setInputPrompt("");

            // 1. Kullanıcı mesajını ekle
            setChatMessages(prev => [...prev, { type: 'user', text: prompt }]);

            // 2. Chatbot/Gemini komutunu işle
            const commandDetails = handleChatResponse(prompt);

            // 3. API'yi çağır
            callImageEditAPI(commandDetails);
        };


        return (
            <div className="min-h-screen text-white p-4 md:p-8 font-sans">
                <header className="text-center mb-8">
                    <h1 className="text-4xl font-extrabold text-blue-400">AI Sohbet Editörü</h1>
                    <p className="text-gray-400 mt-2">Metin komutlarınızla resimlerinizi anında düzenleyin.</p>
                </header>

                <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    {/* Sol Kısım: Resim Görüntüleyici ve Karşılaştırma */}
                    <div className="lg:col-span-2 space-y-4">
                        <div className="bg-gray-800 p-4 rounded-xl shadow-inner">
                            <button 
                                onClick={handleImageUpload}
                                className="w-full inline-flex items-center justify-center p-3 border-2 border-dashed border-blue-600 rounded-lg text-blue-300 hover:bg-gray-700 cursor-pointer transition-colors"
                            >
                                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                Yeni Resim Yükle (Simülasyon)
                            </button>
                        </div>
                        
                        <ImageCompareSlider 
                            originalSrc={originalImage} 
                            modifiedSrc={modifiedImage}
                        />

                    </div>

                    {/* Sağ Kısım: Chatbot Arayüzü */}
                    <div className="lg:col-span-1 flex flex-col h-[500px] md:h-[700px] bg-gray-800 rounded-xl shadow-2xl p-4">
                        <h2 className="text-xl font-bold mb-3 text-blue-300 border-b border-gray-700 pb-2">AI Düzenleme Sohbeti</h2>
                        
                        {/* Mesaj Kutusu */}
                        <div className="flex-grow overflow-y-auto space-y-4 pr-2 custom-scrollbar">
                            {chatMessages.map((msg, index) => (
                                <div key={index} className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[90%] p-3 rounded-xl shadow-md ${
                                        msg.type === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-tl-none'
                                    }`}>
                                        <p className="font-medium text-sm">{msg.text}</p>
                                    </div>
                                </div>
                            ))}
                            {isLoading && (
                                 <div className="flex justify-start">
                                    <div className="max-w-[80%] p-3 rounded-xl shadow-md bg-gray-700 text-gray-200 rounded-tl-none">
                                        <div className="flex items-center space-x-2">
                                            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-400"></div>
                                            <p className="font-medium text-sm">AI düzenliyor...</p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Giriş Alanı */}
                        <form onSubmit={handleSendPrompt} className="mt-4 flex space-x-3">
                            <input 
                                type="text" 
                                value={inputPrompt}
                                onChange={(e) => setInputPrompt(e.target.value)}
                                placeholder="Örn: 'Halı sarı olsun'"
                                className="flex-grow p-3 rounded-lg border border-gray-700 bg-gray-900 text-white focus:ring-2 focus:ring-blue-500 outline-none"
                                disabled={isLoading}
                            />
                            <button 
                                type="submit" 
                                className="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-bold transition-colors disabled:bg-gray-600"
                                disabled={isLoading || !inputPrompt.trim()}
                            >
                                Gönder
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        );
    }
    
    // Uygulamayı DOM'a render et
    ReactDOM.render(<App />, document.getElementById('root'));
</script>

</body>
</html>
