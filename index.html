<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tek Resim DÃ¼zenleyici - AI Destekli ve KaymasÄ±z</title>
<style>
/* --- Genel Stil --- */
body { 
    margin:0; 
    background:#111; 
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    color:white; 
    padding-bottom:40px; 
    font-family:sans-serif; 
}

/* --- Konteyner (KarÅŸÄ±laÅŸtÄ±rma AlanÄ±) --- */
#container { 
    position:relative; 
    width:90vw; 
    max-width:500px; 
    height: auto; 
    overflow:hidden; 
    border-radius:16px; 
    margin-top:20px; 
    background:#222; 
}

/* TÃ¼m img Ã¶ÄŸeleri */
img { 
    width:100%; 
    display:block; 
    pointer-events:none; 
    opacity: 0; 
    transition: opacity 0.5s; 
}

/* --- ARKA PLAN (Filtresiz GÃ¶rÃ¼nÃ¼m) --- */
#original-img {
    position: relative; 
    z-index: 1;
}

/* --- Ã–N PLAN (Filtreli/AI'lÄ± GÃ¶rÃ¼nÃ¼m - Sol Taraf) --- */
#filtered-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 50%; 
    height: 100%;
    overflow: hidden; 
    z-index: 5;
}

/* Filtreli resim kopyasÄ±: KaymasÄ±z hizalama iÃ§in kritik ayar */
#filtered-img {
    position: absolute; 
    top: 0;
    left: 0; 
    width: 100vw; 
    max-width: 500px; 
    height: 100%;
}

/* --- SÃ¼rgÃ¼ Kolu (KalÄ±cÄ± Ã‡ubuk) --- */
#handle { 
    position:absolute; 
    top:0; 
    left:50%; 
    width:6px; 
    height:100%; 
    background:white; 
    cursor:ew-resize; 
    border-radius:3px; 
    z-index:10; 
    transform: translateX(-50%); 
    opacity: 1; 
    display: block; 
}

/* --- Kontroller ve Chatbot Stilleri --- */
.vignette {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 15;
    mix-blend-mode: multiply; 
}
#upload { margin-top:10px; }
#controls { 
    width:90vw; 
    max-width:500px; 
    margin-top:20px; 
    display:flex; 
    flex-direction:column; 
    gap:10px; 
}
#controls label { font-size:14px; }
#controls input[type=range] { width:100%; }
#reset, #save { 
    margin-top:10px; 
    padding:8px 12px; 
    border-radius:6px; 
    cursor:pointer; 
    border: none;
    font-weight: bold;
}
#reset { background:#555; color:white; }
#save { background:#28a745; color:white; }
#chatbot-container {
    width:90vw; 
    max-width:500px; 
    margin-top:30px; 
    padding:10px; 
    border:1px solid #444; 
    border-radius:8px; 
    background:#222;
}
#chat-messages {
    height:150px; 
    overflow-y:auto; 
    margin-bottom:10px; 
    padding:5px; 
    border-bottom:1px solid #333; 
    font-size:14px;
    background: #1a1a1a;
    border-radius: 4px;
}
#chat-messages p { margin: 5px 0; }
#chat-input {
    width:calc(100% - 70px); 
    padding:8px; 
    border:none; 
    border-radius:4px;
}
#chat-send {
    width:60px; 
    padding:8px; 
    background:#007bff; 
    color:white; 
    border:none; 
    border-radius:4px; 
    margin-left:5px; 
    cursor:pointer;
}

</style>
</head>
<body>

<input type="file" id="upload" accept="image/*" />

<div id="container">
    <img id="original-img" src="data:image/svg+xml;charset=utf8,%3Csvg viewBox='0 0 500 300'%3E%3Crect width='500' height='300' fill='%23333'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='20' fill='%23ccc'%3EFiltresiz Arka Plan%3C/text%3E%3C/svg%3E" alt="Filtresiz Resim" />
    
    <div id="handle"></div>
</div>

<div id="controls">
    <label>Kontrast <span id="cVal">100</span>%</label>
    <input type="range" id="contrast" min="50" max="200" value="100">

    <label>ParlaklÄ±k <span id="bVal">100</span>%</label>
    <input type="range" id="brightness" min="50" max="200" value="100">
    
    <label>Doygunluk <span id="sVal">100</span>%</label>
    <input type="range" id="saturate" min="0" max="300" value="100">

    <label>Hue Rotate <span id="hVal">0</span>Â°</label>
    <input type="range" id="hue" min="0" max="360" value="0">

    <label>Sepia <span id="sepVal">0</span>%</label>
    <input type="range" id="sepia" min="0" max="100" value="0">

    <label>Blur <span id="blurVal">0</span>px</label>
    <input type="range" id="blur" min="0" max="10" value="0">

    <label>Opacity <span id="opVal">10</span>%</label>
    <input type="range" id="opacity" min="10" max="100" value="10">

    <label>Vignette <span id="vigVal">0</span>%</label>
    <input type="range" id="vignette" min="0" max="80" value="0">

    <label>Gamma <span id="gammaVal">1</span></label>
    <input type="range" id="gamma" min="0.1" max="3" step="0.1" value="1">

    <button id="reset">SÄ±fÄ±rla</button>
    <button id="save">Kaydet</button>
</div>

<div id="chatbot-container">
    <div id="chat-messages">
        <p style="color:#88ff88;">**AI**: Merhaba! Resmi deÄŸiÅŸtirmek iÃ§in komutlarÄ±nÄ±zÄ± yazÄ±n (Ã–rn: Kontrast 150 yap, kedi Ã§iz, Arka planÄ± deÄŸiÅŸtir).</p>
    </div>
    <input type="text" id="chat-input" placeholder="Komutunuzu yazÄ±n..." >
    <button id="chat-send">GÃ¶nder</button>
</div>


<script>
const upload = document.getElementById("upload");
const originalImg = document.getElementById("original-img"); 
const handle = document.getElementById("handle");
const container = document.getElementById("container");
const saveBtn = document.getElementById("save");

// --- Gerekli Elementleri OluÅŸtur ve DOM'a Ekle ---
const filteredContainer = document.createElement('div');
filteredContainer.id = 'filtered-container';
const filteredImg = document.createElement('img');
filteredImg.id = 'filtered-img';
const vignetteLayer = document.createElement('div');
vignetteLayer.className = 'vignette';

filteredContainer.appendChild(filteredImg);
filteredContainer.appendChild(vignetteLayer);
container.insertBefore(filteredContainer, handle); 
// ---------------------------------------------------

const filters = {
    contrast: document.getElementById("contrast"), brightness: document.getElementById("brightness"), saturate: document.getElementById("saturate"), 
    hue: document.getElementById("hue"), sepia: document.getElementById("sepia"), blur: document.getElementById("blur"), 
    opacity: document.getElementById("opacity"), vignette: document.getElementById("vignette"), gamma: document.getElementById("gamma")
};
const vals = {
    cVal: document.getElementById("cVal"), bVal: document.getElementById("bVal"), sVal: document.getElementById("sVal"), 
    hVal: document.getElementById("hVal"), sepVal: document.getElementById("sepVal"), blurVal: document.getElementById("blurVal"), 
    opVal: document.getElementById("opVal"), vigVal: document.getElementById("vigVal"), gammaVal: document.getElementById("gammaVal")
};
const defaultValues = { contrast: 100, brightness: 100, saturate: 100, hue: 0, sepia: 0, blur: 0, opacity: 10, vignette: 0, gamma: 1 };


function applyFilters() {
    const filterStr = `contrast(${filters.contrast.value}%) brightness(${filters.brightness.value}%) saturate(${filters.saturate.value}%) hue-rotate(${filters.hue.value}deg) sepia(${filters.sepia.value}%) blur(${filters.blur.value}px) opacity(${filters.opacity.value}%)`;
    
    // Filtreler sadece SOL tarafa (filteredImg) uygulanÄ±r.
    filteredImg.style.filter = filterStr;

    // Vinyet ayarÄ± ve deÄŸer gÃ¼ncellemeleri
    const vigVal = filters.vignette.value;
    const shadowSize = vigVal * 1.5; 
    const opacityVal = vigVal / 100 * 0.8; 
    vignetteLayer.style.boxShadow = `0 0 ${shadowSize}px rgba(0, 0, 0, ${opacityVal}) inset`;

    vals.cVal.textContent = filters.contrast.value; 
    vals.bVal.textContent = filters.brightness.value;
    vals.sVal.textContent = filters.saturate.value;
    vals.hVal.textContent = filters.hue.value;
    vals.sepVal.textContent = filters.sepia.value;
    vals.blurVal.textContent = filters.blur.value;
    vals.opVal.textContent = filters.opacity.value;
    vals.vigVal.textContent = filters.vignette.value;
    vals.gammaVal.textContent = filters.gamma.value;
}

Object.values(filters).forEach(el => el.addEventListener("input", applyFilters));


// --- SÃ¼rgÃ¼ Hareketi Ä°ÅŸlevleri ---
let isDragging = false;
function moveHandle(clientX) {
    const rect = container.getBoundingClientRect();
    const offsetX = Math.min(Math.max(clientX - rect.left, 0), rect.width);
    
    handle.style.left = offsetX + 'px';
    filteredContainer.style.width = offsetX + 'px';
}
handle.addEventListener('mousedown', () => isDragging = true);
document.addEventListener('mouseup', () => isDragging = false);
document.addEventListener('mousemove', e => { if(isDragging) moveHandle(e.clientX); });
handle.addEventListener('touchstart', e => { isDragging = true; e.preventDefault(); });
window.addEventListener('touchend', () => isDragging = false);
window.addEventListener('touchmove', e => { if(isDragging) moveHandle(e.touches[0].clientX); });


// --- Resim YÃ¼kleme Ä°ÅŸlevi ---
upload.addEventListener('change', e => {
    const file = e.target.files[0];
    if(!file) return;
    const url = URL.createObjectURL(file);
    
    originalImg.src = url;
    filteredImg.src = url; 

    originalImg.onload = () => {
        originalImg.style.opacity = 1;
        filteredImg.style.opacity = 1; 

        applyFilters();
        handle.style.left = '50%';
        filteredContainer.style.width = '50%';
        
        appendMessage("AI", "Resim yÃ¼klendi. KomutlarÄ±nÄ±zÄ± bekliyorum.", '#88ff88');
    };
});


// --- SÄ±fÄ±rlama ve Kaydetme Ä°ÅŸlevleri (Canvas) ---
document.getElementById('reset').addEventListener('click', () => {
    Object.keys(filters).forEach(key => { filters[key].value = defaultValues[key]; });
    applyFilters();
    handle.style.left = '50%';
    filteredContainer.style.width = '50%';
    appendMessage("AI", "Filtreler sÄ±fÄ±rlandÄ±.", '#88ff88');
});

saveBtn.addEventListener('click', () => {
    if (!originalImg.src || originalImg.src.startsWith('data:image/svg')) { alert("LÃ¼tfen Ã¶nce bir resim yÃ¼kleyin."); return; }
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = originalImg.naturalWidth;
    canvas.height = originalImg.naturalHeight;

    ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height); 
    
    const filterStr = `contrast(${filters.contrast.value}%) brightness(${filters.brightness.value}%) saturate(${filters.saturate.value}%) hue-rotate(${filters.hue.value}deg) sepia(${filters.sepia.value}%) blur(${filters.blur.value}px) opacity(${filters.opacity.value}%)`;
    ctx.filter = filterStr; 
    ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height); 

    if (filters.vignette.value > 0) {
        const vigVal = filters.vignette.value / 100 * 0.8; 
        const gradient = ctx.createRadialGradient(
            canvas.width / 2, canvas.height / 2, 0, canvas.width / 2, canvas.height / 2, Math.max(canvas.width, canvas.height) / 2
        );
        gradient.addColorStop(0, `rgba(0, 0, 0, 0)`);
        gradient.addColorStop(0.5, `rgba(0, 0, 0, 0)`);
        gradient.addColorStop(1, `rgba(0, 0, 0, ${vigVal})`);
        ctx.fillStyle = gradient;
        ctx.globalCompositeOperation = 'source-over'; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    const dataURL = canvas.toDataURL("image/jpeg", 0.9); 
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = 'duzenlenmis_resim.jpg';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    appendMessage("AI", "DÃ¼zenlenmiÅŸ resim kaydedildi.", '#88ff88');
});


// ---------------------------------------------------
// --- CHATBOT VE KOMUT Ä°ÅžLEME ---
// ---------------------------------------------------

const chatInput = document.getElementById("chat-input");
const chatSend = document.getElementById("chat-send");
const chatMessages = document.getElementById("chat-messages");

function appendMessage(sender, message, color) {
    const p = document.createElement('p');
    p.innerHTML = `<strong style="color:${color}">${sender}</strong>: ${message}`;
    chatMessages.appendChild(p);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Filtre adlarÄ±nÄ± TÃ¼rkÃ§e'ye Ã§evirme haritasÄ±
const filterMap = {
    "kontrast": "contrast", "parlaklÄ±k": "brightness", "doygunluk": "saturate", 
    "hue": "hue", "renk": "hue", "sepia": "sepia", 
    "bulanÄ±klÄ±k": "blur", "blur": "blur", "opaklÄ±k": "opacity", 
    "vinyet": "vignette", "gamma": "gamma"
};

function processCommand(command) {
    const parts = command.toLowerCase().split(/\s+/);
    const filterName = parts[0];
    const action = parts[1];
    
    // 1. Filtre KomutlarÄ±nÄ± Ä°ÅŸleme (Kontrast 150)
    if (filterMap[filterName] && !isNaN(parseFloat(action))) {
        const filterKey = filterMap[filterName];
        const filterElement = filters[filterKey];
        const value = parseFloat(action);
        
        const minValue = parseFloat(filterElement.min);
        const maxValue = parseFloat(filterElement.max);

        if (filterElement) {
            const clampedValue = Math.min(Math.max(value, minValue), maxValue);
            filterElement.value = clampedValue;
            applyFilters();
            return `âœ… ${filterName} deÄŸeri ${clampedValue} olarak ayarlandÄ±.`;
        }
    }
    
    if (command.toLowerCase() === 'sÄ±fÄ±rla') {
        document.getElementById('reset').click();
        return "âœ… TÃ¼m filtre ayarlarÄ± sÄ±fÄ±rlandÄ±.";
    }

    if (command.toLowerCase() === 'kaydet') {
        document.getElementById('save').click();
        return "Resim kaydediliyor...";
    }

    // 2. GeliÅŸmiÅŸ AI KomutlarÄ±nÄ± Ä°ÅŸleme (Ä°Ã§erik DeÄŸiÅŸtirme/OluÅŸturma)
    if (command.toLowerCase().includes('ekle') || command.toLowerCase().includes('Ã§iz') || command.toLowerCase().includes('deÄŸiÅŸtir') || command.toLowerCase().includes('yap')) {
        return callWorkerAI(command);
    }
    
    return "âŒ Komut anlaÅŸÄ±lamadÄ±. LÃ¼tfen 'Kontrast 150' veya 'kedi Ã§iz' gibi geÃ§erli bir komut girin.";
}

// ---------------------------------------------------
// --- CLOUDFLARE WORKERS AI BAÄžLANTISI ---
// ---------------------------------------------------

function callWorkerAI(command) {
    // ðŸš¨ BURAYI KONTROL EDÄ°N: Worker URL'si
    const workerUrl = 'https://free-image-generation-api.muhammed251210.workers.dev/'; 

    // Loading mesajÄ± gÃ¶ster
    appendMessage("AI", "ðŸ”„ Komutunuz Cloudflare Worker'a gÃ¶nderiliyor... LÃ¼tfen bekleyin.", '#FFFF00');
    
    fetch(workerUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            prompt: command 
        }),
    })
    .then(response => {
        // HTTP hatalarÄ±nÄ± kontrol et
        if (!response.ok) {
             // Sunucudan gelen hata detayÄ±nÄ± yakala
            return response.json().then(errorData => { 
                throw new Error(errorData.error || `HTTP Hata Kodu: ${response.status}`); 
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.newImage) {
            // BaÅŸarÄ±lÄ± AI yanÄ±tÄ±
            // Yeni AI resmini filteredImg'e atÄ±yoruz.
            filteredImg.src = data.newImage; 
            
            appendMessage("AI", `âœ… AI DÃ¼zenlemesi tamamlandÄ±: "${command}" uygulandÄ±!`, '#88ff88');

            filteredImg.onload = () => {
                filteredImg.style.opacity = 1; 
                originalImg.style.opacity = 1;
                // Yeni resim yÃ¼klendiÄŸinde filtreleri tekrar uygula (eÄŸer varsa)
                applyFilters();
            };

        } else {
            // API'den dÃ¶nen, ancak baÅŸarÄ± bayraÄŸÄ± olmayan bir hata
            appendMessage("AI", `âŒ Hata: AI yanÄ±tÄ± baÅŸarÄ±sÄ±z oldu. Detay: ${data.error || 'Bilinmeyen Hata'}`, '#FF5555');
        }
    })
    .catch(error => {
        // AÄŸ veya fetch hatasÄ±
        appendMessage("AI", `âŒ BaÄŸlantÄ± HatasÄ±: ${error.message}. Worker'Ä±n Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.`, '#FF5555');
        console.error('Fetch Error:', error);
    });

    return `AI komutu ('${command}') Workers AI tarafÄ±ndan iÅŸleniyor. LÃ¼tfen sonucu bekleyin.`;
}


chatSend.addEventListener('click', () => {
    const command = chatInput.value.trim();
    if (command) {
        appendMessage("Siz", command, 'white');
        const response = processCommand(command);
        if (response) {
            appendMessage("AI", response, '#88ff88');
        }
        chatInput.value = '';
    }
});

// Enter tuÅŸu ile gÃ¶nderme
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault(); // VarsayÄ±lan formu gÃ¶nderme davranÄ±ÅŸÄ±nÄ± engelle
        chatSend.click();
    }
});

applyFilters();
</script>
</body>
</html>
